# CPP Relations — Technical Documentation

## Обзор проекта
**CPP Relations** — это интерактивный веб-инструмент для визуализации и анализа зависимостей в C++ проектах. Приложение работает полностью на стороне клиента (Client-side), поддерживает офлайн-режим, интеграцию с Google Gemini / LM Studio и дип-линкинг с IDE (CLion).

---

## 1. Архитектура и Стек Технологий

### Основной стек
*   **Framework:** React 19 (через ES Modules / CDN).
*   **Стилизация:** Tailwind CSS.
*   **Визуализация:** D3.js (SVG манипуляции).
*   **Подсветка синтаксиса:** PrismJS.
*   **AI Integration:** Google GenAI SDK / Fetch API (OpenAI Compatible).
*   **Хранение данных:** IndexedDB (для графов) + LocalStorage (для настроек).

### Структура файлов
*   `App.tsx` — Корневой компонент. Управляет состоянием вкладок, боковой панели и модальных окон. Содержит `ErrorBoundary`.
*   `services/`
    *   `cppParser.ts` — Логика парсинга файлов (C++, CMake, JSON).
    *   `geminiService.ts` — Адаптер для общения с LLM (Gemini или локальные модели).
    *   `localAnalysis.ts` — Офлайн-движок анализа на базе Regex.
    *   `storage.ts` — Обертка над IndexedDB для сохранения больших проектов.
*   `components/`
    *   `GraphVisualization.tsx` — Отрисовка графа, физика (drag&drop), анимация связей.
    *   `ResizableSplit.tsx` — Компонент для реализации изменяемых размеров панелей (Docking system).
*   `types.ts` — TypeScript интерфейсы.

---

## 2. Реализация Ключевых Функций

### A. Парсинг Проекта (`cppParser.ts`)
Вместо тяжеловесных AST-парсеров (типа Clang), используется легковесный подход на базе регулярных выражений и токенизации.
*   **C++:** Поиск директив `#include` для построения ребер графа. Извлечение определений классов и функций (`extractSymbols`) для отображения внутри узлов.
*   **CMake:** Токенизация содержимого файла. Поиск имен файлов и других `CMakeLists.txt` (через `add_subdirectory`) для построения иерархии сборки.
*   **JSON:** Эвристический поиск строковых вхождений имен файлов внутри JSON.

### B. Визуализация Графа (`GraphVisualization.tsx`)
Используется **D3.js**, но стандартная силовая симуляция (`d3-force`) заменена на кастомный **Layered Layout (Слоистый алгоритм)**.
1.  **Топологическая сортировка:** Узлы распределяются по уровням (Level) в зависимости от глубины зависимостей.
2.  **Отрисовка связей:**
    *   *Bezier:* Плавные кривые Безье.
    *   *Orthogonal (Electric):* Ломаные линии с фасками (45°) или прямыми углами (90/180°), имитирующие электрические схемы.
3.  **Анимация:** Использование SVG `<animateMotion>` для создания эффекта потока данных (частицы движутся по путям связей).

### C. Интеграция с AI (`geminiService.ts` & Chat)
*   **Hybrid Context:** Приложение строит карту проекта (список файлов). При запросе в чат, если пользователь упоминает имя файла, его *полное содержимое* инъектируется в системный промпт.
*   **Deep Analysis:** Сравнение двух файлов (Source -> Target). AI объясняет, как именно код одного файла использует другой.
*   **Providers:** Поддержка Google Gemini API и локальных серверов (LM Studio) через совместимый с OpenAI интерфейс.

### D. GUI и UX
*   **Resizable Split Panes:** Реализована система гибких панелей, позволяющая менять ширину Sidebar и соотношение окон кода.
*   **IDE Integration:** Ссылки вида `idea://open?file=...` позволяют открывать файлы прямо в JetBrains CLion.
*   **Virtual File System:** Дерево файлов (`FileTreeItem`) строится динамически из плоского списка путей.

---

## 3. Что можно улучшить (Roadmap)

### Производительность и Парсинг
1.  **WASM Parser (Tree-sitter):** Текущий Regex-парсинг неточен (не понимает контекст, комментарии, макросы). Внедрение `tree-sitter` через WebAssembly позволит строить настоящее AST дерево, находить точные вызовы функций и переходы.
2.  **Web Workers:** Вынос процесса парсинга больших проектов в Web Worker, чтобы не блокировать UI при загрузке тысяч файлов.
3.  **WebGL Rendering:** При графах > 2000 узлов SVG начинает тормозить. Переход на WebGL (например, `PixiJS` или `Cosmograph`) даст 60 FPS на огромных проектах.

### Аналитика и AI
1.  **RAG (Retrieval-Augmented Generation):** Сейчас контекст ограничен. Для больших проектов нужно внедрить векторную базу данных (в браузере, например, `Voyager` или `TensorFlow.js`), чтобы искать релевантный код по смыслу, а не только по имени файла.
2.  **Code Security Scan:** Добавить режим поиска уязвимостей в коде через AI.
3.  **Graph Metrics:** Тепловые карты связности, поиск циклических зависимостей, анализ "God Objects" (файлов с слишком большим числом связей).

### Интерфейс
1.  **Minimap:** Добавить мини-карту навигации по графу.
2.  **Multi-tabs Graph:** Возможность открывать несколько разных графов (например, подграфы разных модулей) в соседних вкладках.
3.  **Git Integration:** (При наличии File System Access API) отображение diff-ов и статуса файлов (изменен/добавлен).

---

## 4. Как запускать и использовать

1.  **Запуск:** Открыть `index.html` (желательно через локальный сервер типа Live Server, но работает и как статика).
2.  **Загрузка проекта:** Нажать "Load Source Folder" и выбрать корневую папку C++ проекта.
3.  **Настройка AI:** Нажать шестеренку, выбрать Gemini (нужен ключ) или Custom (для локальной LLM).
4.  **CLion:** Указать путь к проекту на диске (кнопка "Set Root" во вкладке кода), чтобы работали ссылки открытия.
